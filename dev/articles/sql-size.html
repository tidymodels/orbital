<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>SQL expression sizes • orbital</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="SQL expression sizes">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="orbital.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orbital</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.4.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/orbital.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/database-deployment.html">Database deployment</a></li>
    <li><a class="dropdown-item" href="../articles/databases.html">Using Databases</a></li>
    <li><a class="dropdown-item" href="../articles/pros-cons.html">Pros and Cons</a></li>
    <li><a class="dropdown-item" href="../articles/separate-trees.html">Parallel tree evaluation in databases</a></li>
    <li><a class="dropdown-item" href="../articles/sql-size.html">SQL expression sizes</a></li>
    <li><a class="dropdown-item" href="../articles/supported-models.html">Supported Models and recipes steps</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidymodels/orbital/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>SQL expression sizes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/orbital/blob/main/vignettes/articles/sql-size.Rmd" class="external-link"><code>vignettes/articles/sql-size.Rmd</code></a></small>
      <div class="d-none name"><code>sql-size.Rmd</code></div>
    </div>

    
    
<p>When using orbital to generate SQL for in-database predictions, the
size of the resulting SQL expression varies considerably depending on
the model type and its hyperparameters. Understanding these size
characteristics can help you choose appropriate models for database
deployment.</p>
<div class="section level2">
<h2 id="how-models-translate-to-sql">How models translate to SQL<a class="anchor" aria-label="anchor" href="#how-models-translate-to-sql"></a>
</h2>
<p>Different model types produce fundamentally different SQL
structures:</p>
<p><strong>Linear models</strong> become a single arithmetic
expression—a sum of weighted terms:</p>
<pre><code><span><span class="va">prediction</span> <span class="op">=</span> <span class="va">intercept</span> <span class="op">+</span> <span class="op">(</span><span class="va">coef1</span> <span class="op">*</span> <span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">coef2</span> <span class="op">*</span> <span class="va">x2</span><span class="op">)</span> <span class="op">+</span> <span class="va">...</span></span></code></pre>
<p>SQL size scales linearly with the number of predictors—each predictor
adds one term to the sum. This is far more compact than tree-based
models, where size can grow exponentially with depth.</p>
<p><strong>Tree-based models</strong> become nested
<code>CASE WHEN</code> statements:</p>
<pre><code>CASE WHEN x1 &gt; 5 THEN
  CASE WHEN x2 &gt; 3 THEN 10.5
       ELSE 8.2 END
ELSE
  CASE WHEN x3 &gt; 7 THEN 6.1
       ELSE 4.8 END
END</code></pre>
<p>Each split in the tree adds another condition, and ensemble methods
sum many such trees together.</p>
</div>
<div class="section level2">
<h2 id="tree-depth-affects-sql-size">Tree depth affects SQL size<a class="anchor" aria-label="anchor" href="#tree-depth-affects-sql-size"></a>
</h2>
<p>For tree-based models, the depth of each tree directly impacts SQL
size. Each level of depth can potentially double the number of leaf
nodes, and each leaf requires its own path of conditions.</p>
<pre><code>Depth 1:    2 leaves     -&gt;  ~100 chars per tree
Depth 2:    4 leaves     -&gt;  ~200 chars per tree
Depth 3:    8 leaves     -&gt;  ~400 chars per tree
Depth 4:   16 leaves     -&gt;  ~800 chars per tree
Depth 6:   64 leaves     -&gt;  ~3,000 chars per tree
Depth 8:  256 leaves     -&gt;  ~10,000 chars per tree</code></pre>
<p>In practice, trees rarely grow to their full potential depth because
of early stopping and minimum leaf size constraints. But the
relationship between depth and SQL size remains roughly exponential.</p>
</div>
<div class="section level2">
<h2 id="number-of-trees-in-ensembles">Number of trees in ensembles<a class="anchor" aria-label="anchor" href="#number-of-trees-in-ensembles"></a>
</h2>
<p>For ensemble methods like random forests and boosted trees, the
number of trees is the primary driver of SQL size. Each tree in the
ensemble adds its own block of <code>CASE WHEN</code> expressions, and
these scale linearly:</p>
<pre><code>Trees     SQL Size (depth=3)
─────────────────────────────
   10          ~3,000 chars
   50         ~15,000 chars
  100         ~30,000 chars
  500        ~150,000 chars
1,000        ~300,000 chars</code></pre>
<p>This linear relationship makes it easy to estimate: doubling the
number of trees doubles the SQL size.</p>
</div>
<div class="section level2">
<h2 id="combined-effect-of-trees-and-depth">Combined effect of trees and depth<a class="anchor" aria-label="anchor" href="#combined-effect-of-trees-and-depth"></a>
</h2>
<p>When you change both parameters, the effects multiply:</p>
<pre><code>              Tree Depth
            2       4       6
         ┌───────┬───────┬───────┐
      10 │  2K   │  5K   │  8K   │
Trees 50 │  8K   │ 25K   │ 40K   │
     100 │ 15K   │ 50K   │ 80K   │
         └───────┴───────┴───────┘
                (approximate SQL characters)</code></pre>
<p>A model with 100 trees at depth 6 produces SQL roughly 40x larger
than one with 10 trees at depth 2.</p>
</div>
<div class="section level2">
<h2 id="optimizing-boosted-trees-for-smaller-sql">Optimizing boosted trees for smaller SQL<a class="anchor" aria-label="anchor" href="#optimizing-boosted-trees-for-smaller-sql"></a>
</h2>
<p>For boosted tree models, the number of trees and learning rate are
interchangeable to some degree. Since orbital’s SQL size scales linearly
with the number of trees, you can often achieve similar predictive
performance with fewer trees and a higher learning rate—dramatically
reducing SQL size:</p>
<pre><code>Configuration              RMSE    SQL Size
──────────────────────────────────────────────
500 trees, learning_rate=0.01   0.85    ~150K chars
100 trees, learning_rate=0.05   0.86     ~30K chars
 50 trees, learning_rate=0.10   0.87     ~15K chars</code></pre>
<p>When performance differences are small, there can be substantial SQL
size reductions to gain.</p>
</div>
<div class="section level2">
<h2 id="tuning-for-both-performance-and-sql-size">Tuning for both performance and SQL size<a class="anchor" aria-label="anchor" href="#tuning-for-both-performance-and-sql-size"></a>
</h2>
<p>You can use the <code>extract</code> argument in
<code><a href="https://tune.tidymodels.org/reference/control_grid.html" class="external-link">tune::control_grid()</a></code> to capture orbital object sizes during
hyperparameter tuning:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">extract_orbital_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="fu"><a href="../reference/orbital.html">orbital</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bt_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html" class="external-link">boost_tree</a></span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  tree_depth <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  learn_rate <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"xgboost"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bt_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">bt_spec</span><span class="op">)</span>,</span>
<span>  resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_grid</span><span class="op">(</span>extract <span class="op">=</span> <span class="va">extract_orbital_size</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then combine the extracted sizes with performance metrics to
visualize the trade-off:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="va">bt_res</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_extracts</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>sql_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span>, .by <span class="op">=</span> <span class="va">.config</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bt_res</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"rmse"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">sizes</span>, by <span class="op">=</span> <span class="st">".config"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">sql_size</span>, y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"SQL size (characters)"</span>, y <span class="op">=</span> <span class="st">"RMSE"</span><span class="op">)</span></span></code></pre></div>
<p>Note that object size is a useful proxy but doesn’t perfectly predict
computation time. Database query optimizers, caching, parallelization,
and hardware all affect actual execution speed. A model with 2x the SQL
size won’t necessarily take 2x as long to run. If execution time is
critical, benchmark your top candidates directly in your target database
environment.</p>
</div>
<div class="section level2">
<h2 id="practical-considerations">Practical considerations<a class="anchor" aria-label="anchor" href="#practical-considerations"></a>
</h2>
<p>When choosing models for database deployment:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Linear models</strong> produce the most compact SQL and
are ideal when the relationship is approximately linear.</p></li>
<li><p><strong>Single decision trees</strong> offer a middle ground with
interpretable rules and moderate SQL size.</p></li>
<li><p><strong>Ensemble methods</strong> (random forests, boosted trees)
provide the best predictive performance but generate large SQL
expressions.</p></li>
<li><p><strong>Database limits</strong>: Some databases have query size
limits or performance degradation with very large queries. Test your
generated SQL in your target environment.</p></li>
<li><p><strong>Trade-offs</strong>: You may need to balance model
accuracy against SQL complexity. A simpler model with slightly lower
accuracy might be preferable if it generates manageable SQL.</p></li>
<li><p><strong>Expression depth limits</strong>: Beyond query size, some
databases limit expression nesting depth (e.g., ~1000 in SQLite/DuckDB).
Large tree ensembles can exceed these limits even when the total SQL
size is acceptable. Use <code>separate_trees = TRUE</code> in
<code><a href="../reference/orbital.html">orbital()</a></code> to emit each tree as a separate column with
batched summation, keeping depth well under control. This approach also
enables parallel tree evaluation in columnar databases like DuckDB,
Snowflake, and BigQuery. See <code><a href="../articles/separate-trees.html">vignette("separate-trees")</a></code> for
details.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
